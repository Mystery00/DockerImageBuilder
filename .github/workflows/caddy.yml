name: Build Caddy
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      imageTag:
        description: '镜像Tag'
        required: true
        default: "latest"
        type: string
  push:
    paths:
      - caddy/**
env:
  DOCKER_NAMESPACE: mystery0
  SERVICE_NAME: caddy
jobs:
  pre-build:
    runs-on: ubuntu-latest
    outputs:
      caddy_tag: ${{ steps.caddy_release.outputs.tagName }}
    steps:
      - name: github-release-getter
        uses: Mystery00/github-release-getter@v1.3
        id: caddy_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          repoOwner: caddyserver
          repoName: caddy

  # Job for AMD64 build
  build-amd64:
    runs-on: ubuntu-24.04
    needs: pre-build
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
      - name: Build and push AMD64 image
        uses: docker/build-push-action@v5
        with:
          context: caddy
          platforms: linux/amd64
          build-args: |
            CADDY_VERSION=${{ needs.pre-build.outputs.caddy_tag }}
          file: caddy/Dockerfile
          push: true
          # Push to a unique architecture-specific tag first
          tags: ${{ env.DOCKER_NAMESPACE }}/${{ env.SERVICE_NAME }}:${{ inputs.imageTag || 'latest' }}-amd64
          # Use GHA cache backend
          cache-from: type=gha,scope=caddy-build-amd64
          cache-to: type=gha,scope=caddy-build-amd64,mode=max

  # Job for ARM64 build
  build-arm64:
    runs-on: ubuntu-24.04-arm
    needs: pre-build
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
      - name: Build and push ARM64 image
        uses: docker/build-push-action@v5
        with:
          context: caddy
          platforms: linux/arm64
          build-args: |
            CADDY_VERSION=${{ needs.pre-build.outputs.caddy_tag }}
          file: caddy/Dockerfile
          push: true
          # Push to a unique architecture-specific tag first
          tags: ${{ env.DOCKER_NAMESPACE }}/${{ env.SERVICE_NAME }}:${{ inputs.imageTag || 'latest' }}-arm64
          # Use GHA cache backend
          cache-from: type=gha,scope=caddy-build-arm64
          cache-to: type=gha,scope=caddy-build-arm64,mode=max

  publish-manifest:
    runs-on: ubuntu-latest
    needs: [build-amd64, build-arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Gather Image Tags
        id: meta
        run: echo "TAGS=${{ env.DOCKER_NAMESPACE }}/${{ env.SERVICE_NAME }}:${{ inputs.imageTag || 'latest' }}" >> $GITHUB_OUTPUT

      - name: Create and Push Manifest List
        run: |
          docker buildx imagetools create --tag ${{ steps.meta.outputs.TAGS }} \
            ${{ steps.meta.outputs.TAGS }}-amd64 \
            ${{ steps.meta.outputs.TAGS }}-arm64