name: Build Categraf
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      imageTag:
        description: '镜像Tag'
        required: true
        default: "latest"
        type: string
  push:
    paths:
      - categraf/**
env:
  DOCKER_NAMESPACE: mystery0
  SERVICE_NAME: categraf
jobs:
  pre-build:
    runs-on: ubuntu-latest
    outputs:
      categraf_tag: ${{ steps.categraf_release.outputs.tagName }}
    steps:
      - name: github-release-getter
        uses: Mystery00/github-release-getter@v1.2
        id: categraf_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          repoOwner: flashcatcloud
          repoName: categraf

  # Job for AMD64 build
  build-amd64:
    runs-on: ubuntu-24.04
    needs: pre-build
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
      - name: Build and push AMD64 image
        uses: docker/build-push-action@v5
        with:
          context: categraf
          platforms: linux/amd64
          build-args: |
            CATEGRAF_VERSION=slim-${{ needs.pre-build.outputs.categraf_tag }}
          file: categraf/Dockerfile
          push: true
          # Push to a unique architecture-specific tag first
          tags: ${{ env.DOCKER_NAMESPACE }}/${{ env.SERVICE_NAME }}:${{ inputs.imageTag || 'latest' }}-amd64
          no-cache: true

  # Job for ARM64 build
  build-arm64:
    runs-on: ubuntu-24.04-arm
    needs: pre-build
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
      - name: Build and push ARM64 image
        uses: docker/build-push-action@v5
        with:
          context: categraf
          platforms: linux/arm64
          build-args: |
            CATEGRAF_VERSION=slim-${{ needs.pre-build.outputs.categraf_tag }}
          file: categraf/Dockerfile
          push: true
          # Push to a unique architecture-specific tag first
          tags: ${{ env.DOCKER_NAMESPACE }}/${{ env.SERVICE_NAME }}:${{ inputs.imageTag || 'latest' }}-arm64
          no-cache: true

  publish-manifest:
    runs-on: ubuntu-latest
    needs: [build-amd64, build-arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Gather Image Tags
        id: meta
        run: echo "TAGS=${{ env.DOCKER_NAMESPACE }}/${{ env.SERVICE_NAME }}:${{ inputs.imageTag || 'latest' }}" >> $GITHUB_OUTPUT

      - name: Create and Push Manifest List
        run: |
          docker buildx imagetools create --tag ${{ steps.meta.outputs.TAGS }} \
            ${{ steps.meta.outputs.TAGS }}-amd64 \
            ${{ steps.meta.outputs.TAGS }}-arm64